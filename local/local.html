<!--
      ЭЛЕКТРОННЫЙ ЖУРНАЛ «ШКАЛА»: ЛОКАЛЬНАЯ ВЕРСИЯ ДЛЯ ПРОСМОТРА АРХИВОВ
      Copyright © 2020, А.М.Гольдин. Modified BSD License
-->

<!DOCTYPE html>
<html lang="ru">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<meta http-equiv="Cache-Control" content="no-cache">
<link rel="stylesheet" type="text/css" href="../www/static/style.css">
<link rel="stylesheet" type="text/css" href="../www/static/register.css">
<link rel="stylesheet" type="text/css" href="static/local.css">
<link rel="icon" type="image/x-icon" href="../www/favicon.ico">
<title>ЭЖ «Шкала»: Просмотр архивов</title>

<script>"use strict";
if (!String.prototype.padStart) location.assign("../www/browsers.html");
let db = {}, errMess = "<br><b>Ошибка загрузки базы данных!</b>";

// Чтение одного файла и импорт его в массив с именем типа db["curric"]
const readFile = fl => {   
   let fName  = fl.name,
       dbn    = fName.replace(".db", ''),
       reader = new FileReader();   
   reader.onload = e => {
      let strFile = e.target.result;
      try {
         // Импортируем файл в массив  
         db[dbn] = JSON.parse(
            `[${strFile.trim().replace(/\r/g, '').replace(/\n/g, ',')}]`);
         
         // Чистим массив от удаленных записей
         let delKeys = [];
         db[dbn].map(x => {if (x.$$deleted) delKeys.push(x._id)});
         if (delKeys.length)
            db[dbn] = db[dbn].filter(x => !delKeys.includes(x._id));
         
         document.querySelector("#loadDB textarea").innerHTML +=
            `Файл ${fName} успешно импортирован.\n`;        
      }
      catch(err) {
         document.querySelector("#loadDB textarea").innerHTML +=
            `Ошибка импорта файла ${fName}:\n${err}\n`;
         document.querySelector("#loadResult").innerHTML = errMess;
      }      
   };
   reader.onerror = err => {
      document.querySelector("#loadDB textarea").innerHTML +=
         `Ошибка чтения файла:\n${err}.\n`;
      document.querySelector("#loadResult").innerHTML = errMess;
   }
   reader.readAsText(fl, "utf-8");
}

// Загрузка всех архивных файлов из папки db
const importBase = filesArr => {
   document.querySelector("#loadDB").innerHTML = "<textarea></textarea>";
   document.querySelector("#loadResult").innerHTML =
        "<br><b>База данных успешно загружена</b>"
      + "<button type='button' class='local' onClick='start()'"
      + ">Начать работу</button>";
   for (let fl of filesArr) readFile(fl);   
}
</script>
</head>
<body>

<div id="content">
   <h1 class="local">ЭЖ «ШКАЛА»: ЛОКАЛЬНАЯ ВЕРСИЯ (ПРОСМОТР АРХИВОВ)</h1>
   <h3 class="local">Загрузка базы данных (файлы *.db)</h3>
   <div id="loadDB">
      <button type="button"
         onClick="document.querySelector('#loadDB input').click()"
         >Выберите все файлы папки db</button>
      <input type="file" multiple onChange="importBase(this.files);">
   </div>
   <div id="loadResult"></div> 
</div>

<footer>
<a href="https://scole.goldin.su/manual/" target="_blank">Помощь</a>
</footer>

<script src="js/start.js"></script>

</body>
</html>
